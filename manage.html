<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicine Management System</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .container {
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        h1, h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input, select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        button:hover {
            background-color: #45a049;
        }

        button.delete {
            background-color: #ff4444;
        }

        button.delete:hover {
            background-color: #cc0000;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }

        th, td {
            text-align: left;
            padding: 12px;
            border: 1px solid #ddd;
        }

        th {
            background-color: #f5f5f5;
        }

        .alert {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .alert-success {
            background-color: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }

        .alert-error {
            background-color: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }
    </style>
</head>
<body>
    <h1>Medicine Management System</h1>
    
    <!-- Vendor Management -->
    <div class="container">
        <h2>Vendor Management</h2>
        <form id="vendorForm">
            <div class="form-group">
                <label for="vendorName">Vendor Name:</label>
                <input type="text" id="vendorName" required>
            </div>
            <div class="form-group">
                <label for="vendorWhatsapp">WhatsApp Number:</label>
                <input type="text" id="vendorWhatsapp" placeholder="Include country code">
            </div>
            <button type="submit">Add Vendor</button>
        </form>

        <table id="vendorTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>WhatsApp</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Medicine Management -->
    <div class="container">
        <h2>Medicine Management</h2>
        <form id="medicineForm">
            <div class="form-group">
                <label for="medicineVendor">Select Vendor:</label>
                <select id="medicineVendor" required></select>
            </div>
            <div class="form-group">
                <label for="medicineName">Medicine Name:</label>
                <input type="text" id="medicineName" required>
            </div>
            <button type="submit">Add Medicine</button>
        </form>

        <table id="medicineTable">
            <thead>
                <tr>
                    <th>Medicine Name</th>
                    <th>Vendor</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const SHEET_ID = '1FQg-uoP3eJ3E5NhWAn3k_gJfF0TOm4yyp3955T7UlVY';
const API_KEY = 'AIzaSyAoUbq6tei8kxKILLvXWQO9hT2DmVUK7xU';
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzwkwgYdRwfdK1uAW4x70i9h01sV5InJoi_LOuqFzO6XesPOAwePh-VmOBQNadaK5My/exec';


// Load and render vendors
async function loadVendors() {
    try {
        const data = await fetchSheetData('Vendors!A1:C');
        const vendors = data.slice(1).map(([id, name, whatsapp]) => ({ id, name, whatsapp }));
        
        // Update vendor table
        const tbody = document.querySelector('#vendorTable tbody');
        if (!tbody) {
            console.error('Vendor table tbody not found');
            return [];
        }

        tbody.innerHTML = vendors.map(vendor => `
            <tr>
                <td>${vendor.name}</td>
                <td>${vendor.whatsapp || '-'}</td>
                <td>
                    <button onclick="editVendor('${vendor.id}', '${vendor.name}', '${vendor.whatsapp || ''}')">Edit</button>
                    <button class="delete" onclick="deleteVendor('${vendor.id}')">Delete</button>
                </td>
            </tr>
        `).join('');

        // Update vendor select in medicine form
        const select = document.getElementById('medicineVendor');
        if (select) {
            select.innerHTML = '<option value="">Select Vendor</option>' + 
                vendors.map(vendor => `<option value="${vendor.id}">${vendor.name}</option>`).join('');
        }

        return vendors;
    } catch (error) {
        console.error('Error loading vendors:', error);
        showAlert('Failed to load vendors', 'error');
        return [];
    }
}

// Load and render medicines
async function loadMedicines() {
    try {
        const data = await fetchSheetData('Medicines!A1:C');
        const medicines = data.slice(1).map(([id, vendorId, name]) => ({ id, vendorId, name }));
        
        const vendors = await loadVendors(); // Ensure we have latest vendor data
        const tbody = document.querySelector('#medicineTable tbody');
        if (!tbody) {
            console.error('Medicine table tbody not found');
            return;
        }

        tbody.innerHTML = medicines.map(medicine => {
            const vendor = vendors.find(v => v.id === medicine.vendorId);
            return `
                <tr>
                    <td>${medicine.name}</td>
                    <td>${vendor ? vendor.name : 'Unknown'}</td>
                    <td>
                        <button onclick="editMedicine('${medicine.id}', '${medicine.name}', '${medicine.vendorId}')">Edit</button>
                        <button class="delete" onclick="deleteMedicine('${medicine.id}')">Delete</button>
                    </td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading medicines:', error);
        showAlert('Failed to load medicines', 'error');
    }
}

// Updated fetchSheetData function with better error handling
async function fetchSheetData(range) {
    try {
        console.log(`Fetching data from range: ${range}`);
        const response = await fetch(
            `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`
        );
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Fetched data:', data);
        
        if (!data.values) {
            console.log('No values found in response');
            return [];
        }
        
        return data.values;
    } catch (error) {
        console.error('Error fetching data:', error);
        showAlert(`Failed to load data: ${error.message}`, 'error');
        return [];
    }
}

// Add event listeners and initialize the app
document.addEventListener('DOMContentLoaded', () => {
    console.log('Initializing application...');
    
    // Add form event listeners
    const vendorForm = document.getElementById('vendorForm');
    const medicineForm = document.getElementById('medicineForm');
    
    if (vendorForm) {
        vendorForm.addEventListener('submit', addVendor);
        console.log('Vendor form listener added');
    } else {
        console.error('Vendor form not found');
    }
    
    if (medicineForm) {
        medicineForm.addEventListener('submit', addMedicine);
        console.log('Medicine form listener added');
    } else {
        console.error('Medicine form not found');
    }

    // Initial data load
    loadVendors().then(() => {
        console.log('Vendors loaded');
        return loadMedicines();
    }).then(() => {
        console.log('Medicines loaded');
    }).catch(error => {
        console.error('Error during initial load:', error);
    });
});


// Utility function to show alerts
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    document.body.insertBefore(alertDiv, document.body.firstChild);
    setTimeout(() => alertDiv.remove(), 3000);
}

// Updated makeRequest function with proper error handling
async function makeRequest(operation, data) {
    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ operation, data }),
            mode: 'cors',
        });

        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Operation failed');
        }
        
        return result;
    } catch (error) {
        console.error('Error:', error);
        showAlert(error.message || 'Operation failed', 'error');
        return null;
    }
}

// Updated CRUD operations for Vendors
// Add Vendor (sending data to Google Apps Script)
async function addVendor(event) {
    event.preventDefault(); // Prevent form submission

    const vendorName = document.getElementById('vendorName').value;
    const vendorWhatsapp = document.getElementById('vendorWhatsapp').value;

    const data = {
        operation: 'addVendor',
        data: {
            name: vendorName,
            whatsapp: vendorWhatsapp
        }
    };

    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            loadVendors(); // Reload the vendor list after successful add
            showAlert('Vendor added successfully!', 'success');
        } else {
            showAlert(result.error, 'error');
        }
    } catch (error) {
        showAlert('Error adding vendor: ' + error.message, 'error');
    }
}


function updateVendor({ id, name, whatsapp }) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Vendors');
  const data = sheet.getDataRange().getValues();
  const rowIndex = data.findIndex(row => row[0] === id);
  
  if (rowIndex === -1) throw new Error('Vendor not found');
  
  // Log the row index to debug
  console.log('Updating row at index:', rowIndex + 1);
  
  sheet.getRange(rowIndex + 1, 2, 1, 2).setValues([[name, whatsapp]]);
  return { id };
}

function deleteVendor({ id }) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Vendors');
  const data = sheet.getDataRange().getValues();
  const rowIndex = data.findIndex(row => row[0] === id);
  
  if (rowIndex === -1) throw new Error('Vendor not found');
  
  console.log('Deleting row at index:', rowIndex + 1);
  
  sheet.deleteRow(rowIndex + 1);
  return { id };
}



// Updated CRUD operations for Medicines
async function addMedicine(event) {
    event.preventDefault();
    
    const vendorId = document.getElementById('medicineVendor').value;
    const name = document.getElementById('medicineName').value.trim();
    
    if (!vendorId) {
        showAlert('Please select a vendor', 'error');
        return;
    }
    
    if (!name) {
        showAlert('Medicine name is required', 'error');
        return;
    }
    
    const response = await makeRequest('addMedicine', { vendorId, name });
    if (response?.success) {
        showAlert('Medicine added successfully', 'success');
        document.getElementById('medicineForm').reset();
        await loadMedicines();
    }
}

async function editMedicine(id, currentName, currentVendorId) {
    const name = prompt('Enter new name:', currentName);
    if (!name) return;
    
    // Get current vendors for selection
    const vendors = await fetchSheetData('Vendors');
    const vendorOptions = vendors.slice(1).map(([id, name]) => `${id}: ${name}`).join('\n');
    
    const vendorInput = prompt(`Enter new vendor ID (current vendors):\n${vendorOptions}`, currentVendorId);
    if (!vendorInput) return;
    
    const vendorId = vendorInput.split(':')[0].trim();
    
    const response = await makeRequest('updateMedicine', { id, name, vendorId });
    if (response?.success) {
        showAlert('Medicine updated successfully', 'success');
        await loadMedicines();
    }
}

async function deleteMedicine(id) {
    if (!confirm('Are you sure you want to delete this medicine?')) return;
    
    const response = await makeRequest('deleteMedicine', { id });
    if (response?.success) {
        showAlert('Medicine deleted successfully', 'success');
        await loadMedicines();
    }
}

// Fetch data from Google Sheets
async function fetchSheetData(range) {
    try {
        const response = await fetch(
            `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`
        );
        if (!response.ok) throw new Error('Failed to fetch data');
        const data = await response.json();
        return data.values || [];
    } catch (error) {
        console.error('Error fetching data:', error);
        showAlert('Failed to load data', 'error');
        return [];
    }
}
    </script>
</body>
</html>