<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor-Specific Medicine Order</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f4f4f4;
        }
        .action-buttons button {
            margin-right: 10px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .action-buttons button:hover {
            background-color: #45a049;
        }
        .search-container {
            margin-bottom: 20px;
        }
        .search-container input {
            padding: 8px;
            width: 100%;
            max-width: 300px;
        }
        .vendor-selection {
            margin-bottom: 20px;
        }
        .iPhone-btn {
            padding: 10px 20px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .iPhone-btn:hover {
            background-color: #0056b3;
        }
        .error-message {
            color: red;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.19/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <h1>Order Medicines</h1>

    <!-- Vendor Selection -->
    <div class="vendor-selection">
        <label for="vendorSelect">Select Vendor:</label>
        <select id="vendorSelect" onchange="loadMedicines()">
            <option value="">-- Select Vendor --</option>
        </select>
        <p id="vendorError" class="error-message" style="display: none;">Failed to load vendors. Please try again later.</p>
    </div>

    <!-- Search Box for Medicines -->
    <div class="search-container" id="searchContainer" style="display: none;">
        <label for="medicineSearch">Search Medicines:</label>
        <input type="text" id="medicineSearch" oninput="searchMedicines()" placeholder="Search for a medicine">
    </div>

    <!-- Medicine List -->
    <div>
        <h2>Available Medicines</h2>
        <table>
            <thead>
                <tr>
                    <th>Medicine</th>
                    <th>Quantity</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="medicineTable"></tbody>
        </table>
    </div>

    <!-- Selected Medicines -->
    <div>
        <h2>Selected Medicines</h2>
        <table>
            <thead>
                <tr>
                    <th>Medicine</th>
                    <th>Quantity</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="selectedMedicinesTable"></tbody>
        </table>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button onclick="previewOrder()">Preview Order</button>
        <button class="iPhone-btn" onclick="printOrder()">Print (iPhone Style)</button>
        <button onclick="sendWhatsApp()">Send WhatsApp</button>
        <button onclick="generatePDF()">Generate PDF</button>
    </div>

    <script>
        const SHEET_ID = '1FQg-uoP3eJ3E5NhWAn3k_gJfF0TOm4yyp3955T7UlVY';
        const API_KEY = 'AIzaSyAoUbq6tei8kxKILLvXWQO9hT2DmVUK7xU';

        let vendors = [];
        let currentVendor = null;
        let selectedMedicines = [];
        let filteredMedicines = [];

        async function loadVendors() {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Vendors?key=${API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();

                if (!data.values) throw new Error('No vendors found');

                vendors = data.values.slice(1).map(([id, name, whatsapp]) => ({ id, name, whatsapp }));
                const vendorSelect = document.getElementById('vendorSelect');

                vendors.forEach(vendor => {
                    const option = document.createElement('option');
                    option.value = vendor.id;
                    option.textContent = vendor.name;
                    vendorSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading vendors:', error);
                document.getElementById('vendorError').style.display = 'block';
            }
        }

        async function loadMedicines() {
            const vendorId = document.getElementById('vendorSelect').value;
            if (!vendorId) {
                currentVendor = null;
                document.getElementById('searchContainer').style.display = 'none';
                renderMedicines([]);
                return;
            }

            currentVendor = vendors.find(vendor => vendor.id === vendorId);

            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Medicines?key=${API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                const medicines = data.values.slice(1)
                    .filter(row => row[1] === vendorId)
                    .map(([id, vendorId, name]) => ({ id, name }));

                filteredMedicines = medicines;
                renderMedicines();
                document.getElementById('searchContainer').style.display = 'block';
            } catch (error) {
                console.error('Error loading medicines:', error);
                renderMedicines([]);
            }
        }

        function renderMedicines() {
            const medicineTable = document.getElementById('medicineTable');
            medicineTable.innerHTML = filteredMedicines.map((medicine, index) => `
                <tr>
                    <td>${medicine.name}</td>
                    <td><input type="number" min="1" id="qty-${index}" placeholder="Quantity"></td>
                    <td><button onclick="addMedicine(${index})">Add</button></td>
                </tr>
            `).join('');
        }

        // Remaining functions like `addMedicine`, `previewOrder`, `generatePDF`, etc., are untouched.
    </script>
</body>
</html>
